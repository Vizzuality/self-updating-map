<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Quick quick, HTML</title>

    <link href="css/style.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="css/print.css" media="print" rel="stylesheet" type="text/css" />

    <style>body,html {width:100%; height:100%; margin:0; padding:0;} #map {position:relative; margin:0; width:100%; height:100%;}</style>
    <link rel="stylesheet" href="css/leaflet.css" />
    <!--[if IE]><link rel="stylesheet" href="../css/leaflet.ie.css" /><![endif]-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script src="js/vendor/leaflet.js"></script>
    <script type="text/javascript" src="js/vendor/wax.leaf.min.js"></script>
    <script type="text/javascript" src="js/vendor/cartodb-leaflet-min.js"></script>
    <script type="text/javascript" src="js/vendor/cartodb-popup-min.js"></script>

    <script type="text/javascript">
      var timer, countries, map;

      window.countries = countries;

      var userName = 'viz2';
      var tableName = 'us_elections_2008';
      var lastUpdate = null;

      var refreshInterval = 3000;

      var refresh = function() {

        // console.log('test');

        var url = "http://" + userName + ".cartodb.com/api/v2/sql?q=" + escape("SELECT updated_at FROM " + tableName + " ORDER BY updated_at DESC LIMIT 1");
        console.log(url);

        $.get(url, function(data) {
          var updated_at = data.rows[0].updated_at;
          var updatedAtDate = new Date(Date.parse(updated_at));

          if (updatedAtDate > lastUpdate) {
            console.log("should refresh");

            if (!countries) {

              countries = new L.CartoDBLayer({
                map: map,
                user_name: userName,
                table_name: tableName,
                extra_params: {
                  update: updated_at
                },
                cdn_url: "http://d2c5ry9dy1ewvi.cloudfront.net",
                interactivity: "cartodb_id,obama_win",
                featureOver: function(ev,latlng,pos,data) {
                  document.body.style.cursor = "pointer";
                },
                featureOut: function() {
                  document.body.style.cursor = "default";
                },
                featureClick: function() {},
                auto_bound: false,
                debug: true
              });
              // Adding layer to map
              map.addLayer(countries, false);

            } else {
              countries.setOptions({ extra_params: { update: updated_at } });


            }

          } else {
            console.log("should not refresh");
          }

          lastUpdate = updatedAtDate;


        });

        if (!timer) {
          timer = setInterval(refresh, refreshInterval);
        }

      }

      function initialize() {


        refresh();
        //timer = setInterval(refresh, refreshInterval);

        map = new L.Map('map').setView(new L.LatLng(39.849034, -100.371094), 4);
        var mapboxUrl = 'http://{s}.tiles.mapbox.com/v3/cartodb.map-1nh578vv/{z}/{x}/{y}.png'
        , mapbox = new L.TileLayer(mapboxUrl, {maxZoom: 18, attribution: "OpenStreetMaps"});
        map.addLayer(mapbox,true);

        // Create a CartoDB popup
        var popup = new L.CartoDBPopup();



      }
    </script>


  </head>
  <body onload="initialize();">
    <div id="map"></div>
  </body>
</html>
